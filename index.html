<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuktuk Drive | ÿ™ŸàŸÉÿ™ŸàŸÉ ÿØÿ±ÿßŸäŸÅ</title>
    <meta name="description" content="Fast, secure, and local transport and delivery in Egypt.">

    <style>
        /* =========================================
           CSS VARIABLES & THEME
           ========================================= */
        :root {
            /* Brand Colors */
            --primary: #7C3AED;      /* Electric Purple */
            --primary-hover: #6D28D9;
            --secondary: #06B6D4;    /* Turquoise */
            --accent: #FACC15;       /* Energetic Yellow */
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --success: #10B981;
            --danger: #EF4444;
            
            /* Layout */
            --radius: 16px;
            --max-width: 600px; /* Mobile-first focus */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] {
            --bg-body: #111827;
            --bg-card: #1F2937;
            --text-main: #F9FAFB;
            --text-muted: #9CA3AF;
            --border-color: #374151;
        }

        /* =========================================
           RESET & UTILITIES
           ========================================= */
        * { box-sizing: border-box; margin: 0; padding: 0; transition: all 0.3s ease; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); line-height: 1.5; min-height: 100vh; display: flex; flex-direction: column; }
        
        .container { width: 100%; max-width: var(--max-width); margin: 0 auto; padding: 0 1.5rem; flex: 1; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; } .mb-4 { margin-bottom: 1rem; }

        /* Buttons */
        .btn {
            border: none; padding: 0.8rem 1.5rem; border-radius: 99px; font-weight: 700; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border-color); color: var(--text-main); }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* Cards & Inputs */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1rem; }
        input, select { width: 100%; padding: 0.8rem; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); margin-bottom: 1rem; }
        
        /* =========================================
           HEADER
           ========================================= */
        header { background: var(--bg-card); padding: 1rem 0; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.4rem; font-weight: 900; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .logo span { color: var(--secondary); }
        .nav-icon { padding: 0.5rem; border-radius: 50%; cursor: pointer; background: transparent; border: none; color: var(--text-main); }

        /* =========================================
           LANDING & AUTH
           ========================================= */
        .role-card {
            border: 2px solid var(--border-color); border-radius: var(--radius); padding: 2rem;
            text-align: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .role-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .role-card.active { border-color: var(--primary); background: rgba(124, 58, 237, 0.05); }
        .role-icon { font-size: 3rem; margin-bottom: 1rem; display: block; }

        /* =========================================
           USER DASHBOARD
           ========================================= */
        .service-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .service-option {
            border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem;
            text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .service-option.selected { border-color: var(--secondary); background: rgba(6, 182, 212, 0.1); }
        .service-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* =========================================
           DRIVER DASHBOARD
           ========================================= */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { background: var(--primary); color: white; padding: 1rem; border-radius: 12px; text-align: center; }
        .stat-box h3 { font-size: 0.8rem; opacity: 0.9; }
        .stat-box div { font-size: 1.5rem; font-weight: bold; }
        .request-card { border-right: 5px solid var(--accent); animation: slideIn 0.5s ease; }

        /* =========================================
           DELIVERY FLOW
           ========================================= */
        .delivery-steps { margin-top: 1rem; border-left: 2px solid var(--border-color); padding-left: 1.5rem; position: relative; }
        [dir="rtl"] .delivery-steps { border-left: none; border-right: 2px solid var(--border-color); padding-left: 0; padding-right: 1.5rem; }
        .step { position: relative; margin-bottom: 1.5rem; opacity: 0.5; }
        .step.active { opacity: 1; font-weight: bold; }
        .step::before {
            content: ''; position: absolute; left: -1.9rem; top: 0.2rem; width: 12px; height: 12px;
            background: var(--border-color); border-radius: 50%;
        }
        [dir="rtl"] .step::before { left: auto; right: -1.9rem; }
        .step.completed::before { background: var(--success); }
        
        .proof-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 2px dashed var(--border-color); margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; background: var(--bg-body); }

        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* SVG Icons */
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="container flex justify-between items-center">
            <div class="logo">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
                    <circle cx="7" cy="17" r="2" />
                    <path d="M9 17h6" />
                    <circle cx="17" cy="17" r="2" />
                </svg>
                Tuktuk<span>Drive</span>
            </div>
            <div class="flex gap-2">
                <!-- Prototype Only: Role Switcher -->
                <button class="btn btn-outline" style="padding: 5px 10px; font-size: 0.7rem;" onclick="app.switchRole()" id="role-switcher" title="Switch View for Demo">
                    üîÅ <span data-i18n="switch_role">Switch Role</span>
                </button>
                <button class="nav-icon" onclick="app.toggleTheme()">‚óë</button>
                <button class="nav-icon" onclick="app.toggleLang()">
                    <span id="lang-display" style="font-weight:bold; font-size:0.9rem">EN</span>
                </button>
                <button class="nav-icon hidden" id="logout-btn" onclick="app.logout()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- VIEW 1: LANDING / LOGIN SELECTION -->
        <section id="view-landing" class="container flex flex-col justify-center" style="min-height: 80vh;">
            <div class="text-center mb-4">
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;" data-i18n="welcome_title">Move People & Goods</h1>
                <p style="color: var(--text-muted);" data-i18n="welcome_sub">The fastest way to book a tuk-tuk in Egypt.</p>
            </div>

            <div class="flex flex-col gap-4" style="max-width: 400px; margin: 0 auto; width: 100%;">
                <div class="role-card" onclick="app.showAuth('user')">
                    <span class="role-icon">üôã‚Äç‚ôÇÔ∏è</span>
                    <h3 data-i18n="role_user">I am a Passenger</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);" data-i18n="role_user_desc">Book rides and send packages.</p>
                </div>
                <div class="role-card" onclick="app.showAuth('driver')">
                    <span class="role-icon">üõ∫</span>
                    <h3 data-i18n="role_driver">I am a Driver</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);" data-i18n="role_driver_desc">Receive orders and earn money.</p>
                </div>
            </div>
        </section>

        <!-- VIEW 2: AUTH FORM -->
        <section id="view-auth" class="container hidden flex flex-col justify-center items-center" style="min-height: 70vh;">
            <div class="card w-full" style="max-width: 400px;">
                <h2 class="mb-4" id="auth-title" data-i18n="login">Login</h2>
                <input type="text" id="phone-input" placeholder="01xxxxxxxxx" dir="ltr">
                <input type="password" placeholder="******" dir="ltr">
                <button class="btn btn-primary w-full" onclick="app.doLogin()" data-i18n="btn_continue">Continue</button>
                <p class="text-center mt-4" style="font-size: 0.8rem; color: var(--text-muted);">
                    <span data-i18n="no_account">No account?</span> <a href="#" style="color: var(--primary);">Sign up</a>
                </p>
                <button class="btn btn-ghost w-full mt-2" onclick="app.navigateTo('view-landing')" data-i18n="btn_back">Back</button>
            </div>
        </section>

        <!-- VIEW 3: USER DASHBOARD -->
        <section id="view-user-dash" class="container hidden" style="padding-top: 2rem;">
            <!-- Header User -->
            <div class="flex justify-between items-center mb-4">
                <h2 data-i18n="dash_user_hello">Hello, Ahmed</h2>
                <div class="badge" style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 8px; font-size: 0.8rem;">User</div>
            </div>

            <!-- Active Ride Status (If Any) -->
            <div id="user-active-ride" class="card hidden" style="border: 2px solid var(--primary);">
                <div class="flex justify-between items-center mb-2">
                    <h3 style="color: var(--primary);" data-i18n="status_active">Ride in Progress</h3>
                    <span id="ride-status-badge" style="font-size: 0.8rem; font-weight: bold;">En Route</span>
                </div>
                <p id="ride-details-text" style="color: var(--text-muted); margin-bottom: 1rem;">...</p>
                
                <!-- Delivery Protocol UI -->
                <div id="user-delivery-protocol" class="hidden">
                    <div class="delivery-steps">
                        <div class="step completed" data-i18n="step_pickup">Driver Picked Up</div>
                        <div class="step" id="step-proof-user">
                            <span data-i18n="step_proof_wait">Waiting for Driver Proof...</span>
                            <div id="proof-display-user" class="hidden">
                                <img src="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E" class="proof-img" style="height: 100px;">
                            </div>
                        </div>
                        <div class="step" id="step-confirm-user">
                            <button id="btn-confirm-delivery" class="btn btn-success w-full" disabled onclick="app.confirmDeliveryUser()">
                                ‚úì <span data-i18n="btn_confirm_receipt">Confirm Receipt</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Form -->
            <div id="booking-panel" class="card">
                <h3 class="mb-4" data-i18n="book_new">Book a Ride</h3>
                
                <div class="service-selector">
                    <div class="service-option selected" onclick="app.selectService('personal', this)">
                        <span class="service-icon">üë§</span>
                        <b data-i18n="srv_personal">Personal</b>
                    </div>
                    <div class="service-option" onclick="app.selectService('delivery', this)">
                        <span class="service-icon">üì¶</span>
                        <b data-i18n="srv_delivery">Delivery</b>
                    </div>
                </div>

                <input type="text" data-i18n-ph="pickup_ph" placeholder="Pickup Location (e.g. Home)" value="Current Location">
                <input type="text" id="dest-input" data-i18n-ph="dest_ph" placeholder="Destination">
                
                <button class="btn btn-primary w-full" onclick="app.createRide()" data-i18n="btn_find_tuktuk">Find Tuk-tuk</button>
            </div>
        </section>

        <!-- VIEW 4: DRIVER DASHBOARD -->
        <section id="view-driver-dash" class="container hidden" style="padding-top: 2rem;">
             <!-- Header Driver -->
             <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 data-i18n="dash_driver_hello">Capt. Sayed</h2>
                    <small class="text-muted">Bajaj 2024 ‚Ä¢ ‚≠êÔ∏è 4.9</small>
                </div>
                <div class="badge" style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 8px; font-size: 0.8rem;">Driver</div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <h3 data-i18n="stat_earnings">Today's Earnings</h3>
                    <div id="earnings-val">350 EGP</div>
                </div>
                <div class="stat-box" style="background: var(--secondary);">
                    <h3 data-i18n="stat_trips">Trips</h3>
                    <div>8</div>
                </div>
            </div>

            <!-- Active Job Card -->
            <div id="driver-active-job" class="card hidden request-card">
                <div class="flex justify-between">
                    <h3 data-i18n="job_active">Active Job</h3>
                    <span class="badge" id="driver-job-type">üì¶ Delivery</span>
                </div>
                <div class="mt-4" style="background: var(--bg-body); padding: 1rem; border-radius: 8px;">
                    <p><strong>From:</strong> <span id="job-from">Nasr City</span></p>
                    <p><strong>To:</strong> <span id="job-to">Maadi</span></p>
                    <p><strong>Price:</strong> <span style="color: var(--success); font-weight: bold;">45 EGP</span></p>
                </div>

                <!-- Delivery Actions -->
                <div id="driver-delivery-actions" class="mt-4 hidden">
                    <p class="mb-2" style="font-size: 0.9rem; font-weight: bold;" data-i18n="action_req">Action Required:</p>
                    <button id="btn-upload-proof" class="btn btn-outline w-full" onclick="app.driverUploadProof()">
                        üì∑ <span data-i18n="btn_upload_proof">Upload Proof of Delivery</span>
                    </button>
                    <p id="driver-waiting-msg" class="hidden text-center mt-2 text-muted" data-i18n="msg_wait_user">Waiting for customer confirmation...</p>
                </div>
                
                <button id="btn-end-personal" class="btn btn-primary w-full mt-4 hidden" onclick="app.endPersonalRide()">End Trip</button>
            </div>

            <!-- No Requests State -->
            <div id="driver-idle" class="text-center" style="margin-top: 4rem; opacity: 0.6;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì°</div>
                <h3 data-i18n="msg_online">You are Online</h3>
                <p data-i18n="msg_waiting">Waiting for requests...</p>
            </div>
        </section>
    </main>

    <footer>
        <div class="container text-center" style="padding: 2rem 0; color: var(--text-muted); font-size: 0.9rem;">
            <div class="flex justify-center gap-4 mb-4">
                <a href="#" data-i18n="link_about">About</a>
                <a href="#" data-i18n="link_privacy">Privacy</a>
                <a href="#" data-i18n="link_support">Support</a>
            </div>
            <p>¬© 2025 Tuktuk Drive - Beta Prototype</p>
        </div>
    </footer>

    <script>
        const app = {
            // ================= STATE MANAGEMENT =================
            state: {
                lang: 'ar',
                theme: 'light',
                userType: null, // 'user' or 'driver'
                activeRide: null, // { type: 'personal'|'delivery', status: 'pending'|'active'|'proof_uploaded'|'completed' }
                earnings: 350
            },

            i18n: {
                en: {
                    welcome_title: "Move People & Goods",
                    welcome_sub: "The fastest way to book a tuk-tuk in Egypt.",
                    role_user: "I am a Passenger",
                    role_user_desc: "Book rides and send packages.",
                    role_driver: "I am a Driver",
                    role_driver_desc: "Receive orders and earn money.",
                    login: "Login",
                    btn_continue: "Continue",
                    no_account: "No account?",
                    btn_back: "Back",
                    dash_user_hello: "Hello, Ahmed",
                    dash_driver_hello: "Capt. Sayed",
                    book_new: "Book a Ride",
                    srv_personal: "Personal",
                    srv_delivery: "Delivery",
                    btn_find_tuktuk: "Find Tuk-tuk",
                    pickup_ph: "Pickup Location",
                    dest_ph: "Destination",
                    switch_role: "Switch Role",
                    stat_earnings: "Today's Earnings",
                    stat_trips: "Trips",
                    msg_online: "You are Online",
                    msg_waiting: "Waiting for requests...",
                    job_active: "Active Job",
                    action_req: "Action Required:",
                    btn_upload_proof: "Upload Proof of Delivery",
                    msg_wait_user: "Waiting for customer confirmation...",
                    step_pickup: "Driver Picked Up",
                    step_proof_wait: "Waiting for Driver Proof...",
                    btn_confirm_receipt: "Confirm Receipt",
                    status_active: "Ride in Progress",
                    link_about: "About",
                    link_privacy: "Privacy",
                    link_support: "Support"
                },
                ar: {
                    welcome_title: "ŸÖÿ¥ÿßŸàŸäÿ±ŸÉ Ÿàÿ™ŸàÿµŸäŸÑŸÉ ŸÅŸä ŸÖŸÉÿßŸÜ Ÿàÿßÿ≠ÿØ",
                    welcome_sub: "ÿ£ÿ≥ÿ±ÿπ ÿ∑ÿ±ŸäŸÇÿ© ŸÑÿ≠ÿ¨ÿ≤ ÿ™ŸàŸÉÿ™ŸàŸÉ ŸÅŸä ŸÖÿµÿ±.",
                    role_user: "ÿ£ŸÜÿß ÿ±ÿßŸÉÿ®",
                    role_user_desc: "ÿßÿ≠ÿ¨ÿ≤ ŸÖÿ¥ÿßŸàŸäÿ± Ÿàÿßÿ®ÿπÿ™ ÿ∑ŸÑÿ®ÿßÿ™.",
                    role_driver: "ÿ£ŸÜÿß ÿ≥ÿßÿ¶ŸÇ",
                    role_driver_desc: "ÿßÿ≥ÿ™ŸÇÿ®ŸÑ ÿ∑ŸÑÿ®ÿßÿ™ Ÿàÿ≤ŸàÿØ ÿØÿÆŸÑŸÉ.",
                    login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                    btn_continue: "ŸÖÿ™ÿßÿ®ÿπÿ©",
                    no_account: "ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü",
                    btn_back: "ÿ±ÿ¨Ÿàÿπ",
                    dash_user_hello: "ÿ£ŸáŸÑÿßŸãÿå ÿ£ÿ≠ŸÖÿØ",
                    dash_driver_hello: "ŸÉÿßÿ®ÿ™ŸÜ ÿ≥ŸäÿØ",
                    book_new: "ÿ≠ÿ¨ÿ≤ ŸÖÿ¥Ÿàÿßÿ±",
                    srv_personal: "ŸÖÿ¥Ÿàÿßÿ± ÿ¥ÿÆÿµŸä",
                    srv_delivery: "ÿ™ŸàÿµŸäŸÑ ÿ®ÿ∂ÿßÿπÿ©",
                    btn_find_tuktuk: "ÿ®ÿ≠ÿ´ ÿπŸÜ ÿ™ŸàŸÉÿ™ŸàŸÉ",
                    pickup_ph: "ŸÖŸÉÿßŸÜ ÿßŸÑÿßŸÜÿ∑ŸÑÿßŸÇ",
                    dest_ph: "ÿßŸÑŸàÿ¨Ÿáÿ©",
                    switch_role: "ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿØŸàÿ±",
                    stat_earnings: "ÿ£ÿ±ÿ®ÿßÿ≠ ÿßŸÑŸäŸàŸÖ",
                    stat_trips: "ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™",
                    msg_online: "ÿ£ŸÜÿ™ ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ",
                    msg_waiting: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™...",
                    job_active: "ÿ∑ŸÑÿ® ÿ¨ÿßÿ±Ÿä",
                    action_req: "ŸÖÿ∑ŸÑŸàÿ® ŸÖŸÜŸÉ:",
                    btn_upload_proof: "ÿ±ŸÅÿπ ÿ•ÿ´ÿ®ÿßÿ™ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ",
                    msg_wait_user: "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿπŸÖŸäŸÑ...",
                    step_pickup: "ÿßŸÑÿ≥ÿßÿ¶ŸÇ ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®",
                    step_proof_wait: "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿ´ÿ®ÿßÿ™ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ...",
                    btn_confirm_receipt: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ",
                    status_active: "ÿßŸÑŸÖÿ¥Ÿàÿßÿ± ÿ¨ÿßÿ±Ÿä",
                    link_about: "ÿπŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ",
                    link_privacy: "ÿßŸÑÿÆÿµŸàÿµŸäÿ©",
                    link_support: "ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä"
                }
            },

            // ================= INITIALIZATION =================
            init() {
                this.updateLang();
                // Start at landing
                this.navigateTo('view-landing');
            },

            // ================= NAVIGATION & UI =================
            navigateTo(viewId) {
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                
                const isAuth = viewId === 'view-user-dash' || viewId === 'view-driver-dash';
                document.getElementById('logout-btn').classList.toggle('hidden', !isAuth);
                document.getElementById('role-switcher').classList.toggle('hidden', !isAuth);
            },

            showAuth(type) {
                this.state.pendingAuthType = type;
                this.navigateTo('view-auth');
                const title = type === 'user' ? this.i18n[this.state.lang].role_user : this.i18n[this.state.lang].role_driver;
                document.getElementById('auth-title').innerText = this.i18n[this.state.lang].login + ': ' + title;
            },

            doLogin() {
                const type = this.state.pendingAuthType;
                this.state.userType = type;
                
                if(type === 'user') {
                    this.renderUserDash();
                    this.navigateTo('view-user-dash');
                } else {
                    this.renderDriverDash();
                    this.navigateTo('view-driver-dash');
                }
            },

            logout() {
                this.state.userType = null;
                this.state.activeRide = null;
                this.navigateTo('view-landing');
            },

            // Helper for Prototype: Switch between Dashboards
            switchRole() {
                if (this.state.userType === 'user') {
                    this.state.userType = 'driver';
                    this.renderDriverDash();
                    this.navigateTo('view-driver-dash');
                } else {
                    this.state.userType = 'user';
                    this.renderUserDash();
                    this.navigateTo('view-user-dash');
                }
            },

            // ================= USER LOGIC =================
            selectService(type, el) {
                document.querySelectorAll('.service-option').forEach(d => d.classList.remove('selected'));
                el.classList.add('selected');
                el.dataset.selectedType = type;
            },

            createRide() {
                const dest = document.getElementById('dest-input').value;
                if(!dest) return alert(this.state.lang === 'ar' ? 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸàÿ¨Ÿáÿ©' : 'Enter destination');

                const typeEl = document.querySelector('.service-option.selected');
                const type = typeEl.dataset.selectedType || 'personal';

                // Simulate Logic
                const btn = document.querySelector('#booking-panel .btn-primary');
                const oldText = btn.innerText;
                btn.innerText = "‚åõ ...";
                
                setTimeout(() => {
                    // Set shared state
                    this.state.activeRide = {
                        type: type,
                        dest: dest,
                        status: 'active',
                        price: '45 EGP'
                    };

                    this.renderUserDash();
                    alert(this.state.lang === 'ar' ? 'ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ≥ÿßÿ¶ŸÇ!' : 'Driver Found!');
                    btn.innerText = oldText;
                }, 1500);
            },

            renderUserDash() {
                const ride = this.state.activeRide;
                const panel = document.getElementById('booking-panel');
                const statusCard = document.getElementById('user-active-ride');
                const protocol = document.getElementById('user-delivery-protocol');

                if (!ride) {
                    panel.classList.remove('hidden');
                    statusCard.classList.add('hidden');
                } else {
                    panel.classList.add('hidden');
                    statusCard.classList.remove('hidden');
                    document.getElementById('ride-details-text').innerText = `${ride.dest} ‚Ä¢ ${ride.price}`;
                    
                    if (ride.type === 'delivery') {
                        protocol.classList.remove('hidden');
                        // Check flow steps
                        if (ride.status === 'proof_uploaded') {
                            document.getElementById('step-proof-user').classList.add('active');
                            document.getElementById('proof-display-user').classList.remove('hidden');
                            document.getElementById('btn-confirm-delivery').disabled = false;
                            document.querySelector('[data-i18n="step_proof_wait"]').innerText = "Proof Received";
                        }
                    } else {
                        protocol.classList.add('hidden');
                    }
                }
            },

            confirmDeliveryUser() {
                if(confirm("Confirm receipt of goods?")) {
                    this.state.activeRide = null; // Clear ride
                    this.renderUserDash();
                    alert("Trip Completed. Rated 5 Stars automatically.");
                }
            },

            // ================= DRIVER LOGIC =================
            renderDriverDash() {
                const ride = this.state.activeRide;
                const idle = document.getElementById('driver-idle');
                const activeCard = document.getElementById('driver-active-job');
                
                if (!ride) {
                    idle.classList.remove('hidden');
                    activeCard.classList.add('hidden');
                } else {
                    idle.classList.add('hidden');
                    activeCard.classList.remove('hidden');
                    
                    document.getElementById('job-to').innerText = ride.dest;
                    document.getElementById('driver-job-type').innerText = ride.type === 'personal' ? 'üë§ Personal' : 'üì¶ Delivery';
                    
                    const delActions = document.getElementById('driver-delivery-actions');
                    const persActions = document.getElementById('btn-end-personal');
                    
                    if (ride.type === 'delivery') {
                        delActions.classList.remove('hidden');
                        persActions.classList.add('hidden');
                        
                        if (ride.status === 'proof_uploaded') {
                            document.getElementById('btn-upload-proof').classList.add('hidden');
                            document.getElementById('driver-waiting-msg').classList.remove('hidden');
                        } else {
                            document.getElementById('btn-upload-proof').classList.remove('hidden');
                            document.getElementById('driver-waiting-msg').classList.add('hidden');
                        }
                    } else {
                        delActions.classList.add('hidden');
                        persActions.classList.remove('hidden');
                    }
                }
            },

            driverUploadProof() {
                // Simulate upload
                const btn = document.getElementById('btn-upload-proof');
                btn.innerText = "Uploading...";
                setTimeout(() => {
                    this.state.activeRide.status = 'proof_uploaded';
                    this.renderDriverDash(); // Updates driver UI
                    // Note: In a real app, socket event sends this to User
                }, 1000);
            },

            endPersonalRide() {
                this.state.activeRide = null;
                this.state.earnings += 45;
                document.getElementById('earnings-val').innerText = this.state.earnings + " EGP";
                this.renderDriverDash();
                alert("Trip Ended.");
            },

            // ================= THEME & LANG =================
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', this.state.theme);
            },

            toggleLang() {
                this.state.lang = this.state.lang === 'ar' ? 'en' : 'ar';
                document.documentElement.setAttribute('lang', this.state.lang);
                document.documentElement.setAttribute('dir', this.state.lang === 'ar' ? 'rtl' : 'ltr');
                document.getElementById('lang-display').innerText = this.state.lang === 'ar' ? 'EN' : 'ÿπÿ±ÿ®Ÿä';
                this.updateLang();
                
                // Re-render auth title if visible
                if(!document.getElementById('view-auth').classList.contains('hidden')) {
                    const type = this.state.pendingAuthType;
                    if(type) {
                        const title = type === 'user' ? this.i18n[this.state.lang].role_user : this.i18n[this.state.lang].role_driver;
                        document.getElementById('auth-title').innerText = this.i18n[this.state.lang].login + ': ' + title;
                    }
                }
            },

            updateLang() {
                const t = this.i18n[this.state.lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    el.innerText = t[el.getAttribute('data-i18n')];
                });
                document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                    el.placeholder = t[el.getAttribute('data-i18n-ph')];
                });
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
